#!/usr/bin/env bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the repository root
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

# Check if hostname argument is provided
if [ $# -ne 1 ]; then
  echo -e "${RED}Usage: $0 <hostname>${NC}"
  echo "Example: $0 webserver"
  exit 1
fi

HOSTNAME="$1"
HOST_DIR="hosts/$HOSTNAME"
HOME_DIR="home/hosts/$HOSTNAME"

# Validate hostname format
if [[ ! "$HOSTNAME" =~ ^[a-z0-9-]+$ ]]; then
  echo -e "${RED}Error: Hostname must contain only lowercase letters, numbers, and hyphens${NC}"
  exit 1
fi

echo -e "${GREEN}Setting up NixOS host: $HOSTNAME${NC}"
echo

# Get description
read -p "Brief description of this machine: " DESCRIPTION
if [ -z "$DESCRIPTION" ]; then
  DESCRIPTION="NixOS machine"
fi
echo

# Step 1: Copy template (idempotent - skip if exists)
echo -e "${YELLOW}[1/7]${NC} Template setup"
if [ -d "$HOST_DIR" ]; then
  echo -e "${BLUE}⊙ Host directory already exists, skipping template copy${NC}"
else
  cp -r hosts/template "$HOST_DIR"
  rm -f "$HOST_DIR/hardware-configuration.nix.example"
  echo "✓ Template copied to $HOST_DIR"
fi
echo

# Step 2: Generate hardware config (idempotent - skip if exists)
echo -e "${YELLOW}[2/7]${NC} Hardware configuration"
if [ -f "$HOST_DIR/hardware-configuration.nix" ]; then
  echo -e "${BLUE}⊙ Hardware configuration already exists, skipping${NC}"
else
  read -p "Generate hardware configuration now? (y/n): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    if command -v nixos-generate-config >/dev/null 2>&1; then
      echo "Generating hardware configuration..."
      nixos-generate-config --show-hardware-config > "$HOST_DIR/hardware-configuration.nix"
      echo "✓ Hardware configuration generated"
    else
      echo -e "${RED}Error: nixos-generate-config not found. Are you on NixOS?${NC}"
      echo "You'll need to generate hardware-configuration.nix manually later."
    fi
  else
    echo "⊗ Skipped - you'll need to create hardware-configuration.nix manually"
    echo "  Run: nixos-generate-config --show-hardware-config > $HOST_DIR/hardware-configuration.nix"
  fi
fi
echo

# Step 3: Static IP configuration (idempotent - detect if already configured)
echo -e "${YELLOW}[3/7]${NC} Network configuration"
STATIC_IP=""

# Check if configuration already has a real IP (not the sentinel)
if [ -f "$HOST_DIR/configuration.nix" ] && ! grep -q "__NIXOS_STATIC_IP__" "$HOST_DIR/configuration.nix"; then
  # Extract existing IP
  STATIC_IP=$(grep -oP 'address = "\K[0-9.]+' "$HOST_DIR/configuration.nix" | head -1)
  echo -e "${BLUE}⊙ Static IP already configured: $STATIC_IP${NC}"
  read -p "Change it? (y/n): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "✓ Keeping existing IP: $STATIC_IP"
    echo
  else
    STATIC_IP=""
  fi
fi

# Prompt for IP if not already set
if [ -z "$STATIC_IP" ]; then
  while true; do
    read -p "Enter static IP (192.168.1.2XX): " STATIC_IP
    if [[ "$STATIC_IP" =~ ^192\.168\.1\.2[0-9]{2}$ ]]; then
      break
    else
      echo -e "${RED}Invalid IP. Must be in range 192.168.1.200-299${NC}"
    fi
  done
  echo "✓ Static IP: $STATIC_IP"
  echo
fi

# Step 4: Update hostname, description, and static IP in configuration.nix (idempotent - always safe to re-run)
echo -e "${YELLOW}[4/7]${NC} Updating configuration.nix..."
if [ -f "$HOST_DIR/configuration.nix" ]; then
  sed -i "s/__NIXOS_HOSTNAME__/$HOSTNAME/g" "$HOST_DIR/configuration.nix"
  sed -i "s/__NIXOS_DESCRIPTION__/$DESCRIPTION/g" "$HOST_DIR/configuration.nix"
  sed -i "s/__NIXOS_STATIC_IP__/$STATIC_IP/g" "$HOST_DIR/configuration.nix"
  # Also update if the IP changed
  sed -i "s/address = \"[0-9.]*\";/address = \"$STATIC_IP\";/" "$HOST_DIR/configuration.nix"
  echo "✓ Configuration updated"
else
  echo -e "${RED}Error: $HOST_DIR/configuration.nix not found${NC}"
  exit 1
fi
echo

# Step 5: Inject into flake.nix (idempotent - skip if already exists)
echo -e "${YELLOW}[5/7]${NC} Adding host to flake.nix..."
if grep -q "nixosConfigurations.$HOSTNAME" flake.nix; then
  echo -e "${BLUE}⊙ Host already exists in flake.nix, skipping${NC}"
else
  FLAKE_ENTRY="
    nixosConfigurations.$HOSTNAME = nixpkgs.lib.nixosSystem {
      system = \"x86_64-linux\";
      modules = [
        ./hosts/$HOSTNAME/configuration.nix
        ./hosts/$HOSTNAME/hardware-configuration.nix
        home-manager.nixosModules.home-manager
        {
          nixpkgs.config.allowUnfree = true;

          home-manager = {
            users.dbalatero = {
              imports = [
                ./home/hosts/$HOSTNAME
                nixvim.homeModules.nixvim
                stylix.homeModules.stylix
              ];
            };

            useGlobalPkgs = true;
            extraSpecialArgs = {inherit inputs;};
          };
        }
      ];
    };
"

  # Insert after the NEW_HOST_SENTINEL line
  awk -v entry="$FLAKE_ENTRY" '
    /NEW_HOST_SENTINEL/ {
      print
      print entry
      next
    }
    { print }
  ' flake.nix > flake.nix.tmp
  mv flake.nix.tmp flake.nix
  echo "✓ Host added to flake.nix"
fi
echo

# Step 6: Create home-manager config (idempotent - skip if exists)
echo -e "${YELLOW}[6/7]${NC} Home-manager configuration"
if [ -f "$HOME_DIR/default.nix" ]; then
  echo -e "${BLUE}⊙ Home-manager config already exists, skipping${NC}"
else
  mkdir -p "$HOME_DIR"
  cat > "$HOME_DIR/default.nix" <<EOF
{
  ...
}: {
  imports = [
    ../../modules/default.nix
  ];

  home.homeDirectory = "/home/dbalatero";
  home.username = "dbalatero";
}
EOF
  echo "✓ Home-manager config created"
fi
echo

# Step 7: Stage files (idempotent - git add is idempotent)
echo -e "${YELLOW}[7/7]${NC} Staging files for git..."
git add "$HOST_DIR/" 2>/dev/null || true
git add "$HOME_DIR/" 2>/dev/null || true
git add flake.nix 2>/dev/null || true
echo "✓ Files staged"
echo

# Step 8: Deploy (optional, but safe to re-run)
echo -e "${YELLOW}[8/8]${NC} Deployment"
read -p "Deploy configuration now? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "Running: sudo nixos-rebuild switch --flake .#$HOSTNAME"
  sudo nixos-rebuild switch --flake ".#$HOSTNAME"
else
  echo "⊗ Skipped - deployment command:"
  echo "  sudo nixos-rebuild switch --flake .#$HOSTNAME"
fi
echo

# Summary
echo -e "${GREEN}=== Setup Complete ===${NC}"
echo "Host: $HOSTNAME"
echo "Location: $HOST_DIR"
echo "Static IP: $STATIC_IP"
echo
echo "Next steps:"
echo "1. Review configuration: $HOST_DIR/configuration.nix"
echo "2. Review home config: $HOME_DIR/default.nix"
echo "3. Commit changes when ready"
echo
echo "For more information, see hosts/README.md"
