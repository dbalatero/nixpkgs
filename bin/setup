#!/usr/bin/env bash

set -e

source "${BASH_SOURCE%/*}/shared.sh"

function source_nix_shell() {
  if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
}

function install_nix() {
  if ! command_exists nix; then
    curl --proto '=https' --tlsv1.2 -sSf \
      -L https://install.determinate.systems/nix |
      sh -s -- install \
        --diagnostic-endpoint "" \
        --no-confirm \
        --explain
  else
    echo "Nix already installed, skipping"
  fi
}

function configure_default_shell() {
  # Check if running on NixOS
  if uname -a | grep -qi nixos || [ -f /etc/NIXOS ]; then
    echo "Running on NixOS - shell configuration handled by home-manager"
    return 0
  fi

  local nix_zsh="$HOME/.nix-profile/bin/zsh"

  # Check if zsh is available
  if [ ! -f "$nix_zsh" ]; then
    echo "zsh not found in nix profile, skipping shell configuration"
    return 0
  fi

  # Check if already in /etc/shells
  if grep -qxF "$nix_zsh" /etc/shells 2>/dev/null; then
    echo "zsh already in /etc/shells"
  else
    echo "Adding $nix_zsh to /etc/shells (requires sudo)"
    echo "$nix_zsh" | sudo tee -a /etc/shells
  fi

  # Check if already the default shell
  if [ "$SHELL" = "$nix_zsh" ]; then
    echo "zsh is already your default shell"
  else
    echo "Changing default shell to zsh"
    chsh -s "$nix_zsh"
    echo "Shell changed to zsh. Please log out and back in for the change to take effect."
  fi
}

function clone_spoon() {
  local spoon_name="$1"
  local spoons_dir="$HOME/.config/nixpkgs/home/modules/gui/macos/hammerspoon/config/Spoons"
  local spoon_path="$spoons_dir/$spoon_name"

  if [ ! -d "$spoon_path" ]; then
    echo "Cloning $spoon_name..."
    git clone "https://github.com/dbalatero/$spoon_name.git" "$spoon_path"
  else
    echo "$spoon_name already exists"
  fi
}

function clone_hammerspoon_spoons() {
  # Only run on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    return 0
  fi

  echo "Setting up Hammerspoon spoons..."
  clone_spoon "HyperKey.spoon"
  clone_spoon "VimMode.spoon"
  clone_spoon "SkyRocket.spoon"
}

command_exists curl || (echo "curl is required to run" && exit 1)
command_exists hostname || (echo "hostname is required to run" && exit 1)

install_nix
source_nix_shell
clone_hammerspoon_spoons
./bin/switch
configure_default_shell
