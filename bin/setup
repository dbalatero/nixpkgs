#!/usr/bin/env bash

set -e

function command_exists() {
  local name=$1
  command -v "$name" >/dev/null 2>&1
}

function source_nix_shell() {
  if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
  fi
}

function install_nix() {
  if ! command_exists nix ; then
    curl --proto '=https' --tlsv1.2 -sSf \
      -L https://install.determinate.systems/nix \
      | sh -s -- install

    source_nix_shell

    sudo -i nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
    sudo -i nix-channel --update nixpkgs
  else
    echo "Nix already installed, skipping"
  fi
}

function install_home_manager() {
  if ! command_exists "home-manager" ; then
    nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    nix-channel --update

    nix-shell '<home-manager>' -A install
  fi
}

command_exists curl || (echo "curl is required to run" && exit 1)
source_nix_shell
install_nix
install_home_manager
